<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Firebase App (core) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<!-- Firebase Realtime Database -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
  // Your Firebase config from your Firebase console (update with your actual config)
  const firebaseConfig = {
    apiKey: "AIzaSyANzmW0D3f50iOJZTWRT6LeiO_TF0KzAHM",
    authDomain: "wheeler-budget.firebaseapp.com",
    databaseURL: "https://wheeler-budget-default-rtdb.firebaseio.com",  // Make sure this matches your Realtime DB URL
    projectId: "wheeler-budget",
    storageBucket: "wheeler-budget.firebasestorage.app",
    messagingSenderId: "181230172406",
    appId: "1:181230172406:web:432a1f509e76b3c1c614d7",
    measurementId: "G-5HS0K16RHT"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  database.ref('familyBudgetState').on('value', snapshot => {
  if (snapshot.exists()) {
    state = snapshot.val();
    renderAll();
  }
});


  // Reference to Realtime Database
  const database = firebase.database();
</script>

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Family Budget Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f3f4f6;
            padding-bottom: 220px; /* Space for the fixed footer */
        }
        input[type="checkbox"] {
            accent-color: #10b981; 
            width: 1.25rem;
            height: 1.25rem;
            cursor: pointer;
        }
        .strikethrough {
            text-decoration: line-through;
            color: #9ca3af;
        }
        /* Hide number input spinners */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <!-- Header -->
    <header class="bg-slate-900 text-white p-5 shadow-lg sticky top-0 z-50">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold flex items-center gap-2">
                    <i class="fas fa-chart-line text-emerald-400"></i> Family Budget
                </h1>
                <p class="text-slate-400 text-xs">Projected vs. Actual</p>
            </div>
            <button onclick="resetMonth()" class="text-xs bg-slate-800 hover:bg-red-600 text-white px-3 py-2 rounded transition border border-slate-700">
                <i class="fas fa-sync-alt mr-1"></i> New Month
            </button>
        </div>
    </header>

    <main class="max-w-4xl mx-auto p-4 space-y-6 mt-2">

        <!-- 1. INCOME LOG -->
        <section class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="bg-blue-50 p-3 border-b border-blue-100 flex justify-between items-center">
                <h2 class="font-bold text-blue-800 text-sm"><i class="fas fa-money-bill-wave mr-2"></i> Income Log</h2>
                <span class="text-blue-600 font-bold" id="total-income-display">$0.00</span>
            </div>
            <div class="p-4">
                <div class="flex flex-col sm:flex-row gap-2 mb-4">
                    <input type="date" id="inc-date" class="border p-2 rounded w-full sm:w-auto text-sm" />
                    <input type="text" id="inc-desc" placeholder="Source (e.g. My Check)" class="border p-2 rounded w-full text-sm" />
                    <input type="number" id="inc-amount" placeholder="Amount" class="border p-2 rounded w-full sm:w-32 text-sm" />
                    <button onclick="addIncome()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 font-medium text-sm shadow-sm">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                <div id="income-list" class="space-y-2 text-sm"></div>
            </div>
        </section>

        <!-- 2. HUSBAND'S DYNAMIC SECTION -->
        <section class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden border-l-4 border-l-indigo-500">
            <div class="p-3 bg-indigo-50 border-b border-indigo-100 flex justify-between items-center">
                <div>
                    <h2 class="font-bold text-indigo-900 text-sm"><i class="fas fa-gas-pump mr-2"></i> Your Pay Cycles</h2>
                </div>
                <button onclick="addHusbandCycle()" class="bg-indigo-600 hover:bg-indigo-700 text-white text-xs px-3 py-2 rounded shadow-sm">
                    <i class="fas fa-plus-circle mr-1"></i> Add Cycle
                </button>
            </div>
            
            <div id="husband-cycles-container" class="p-4 space-y-4 bg-gray-50 min-h-[50px]">
                <p id="husband-empty-msg" class="text-center text-gray-400 text-xs italic py-2">Click "Add Cycle" when you get a paycheck.</p>
            </div>
        </section>

        <!-- 3. WIFE SECTIONS (Fixed) -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            
            <!-- Wife 1st -->
            <section class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden border-t-4 border-t-emerald-500">
                <div class="p-3 bg-gray-50 border-b flex justify-between cursor-pointer hover:bg-gray-100" onclick="toggleSection('wife1-body')">
                    <h2 class="font-bold text-gray-800 text-sm">ðŸ‘© Wife: 1st</h2>
                    <span class="text-gray-400 text-xs" id="w1-proj-total">$1,731.96 Proj.</span>
                </div>
                <div id="wife1-body" class="p-2 space-y-2">
                    <!-- Injected via JS -->
                </div>
            </section>

            <!-- Wife 15th -->
            <section class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden border-t-4 border-t-teal-500">
                <div class="p-3 bg-gray-50 border-b flex justify-between cursor-pointer hover:bg-gray-100" onclick="toggleSection('wife2-body')">
                    <h2 class="font-bold text-gray-800 text-sm">ðŸ‘© Wife: 15th</h2>
                    <span class="text-gray-400 text-xs" id="w2-proj-total">$1,897.00 Proj.</span>
                </div>
                <div id="wife2-body" class="p-2 space-y-2">
                    <!-- Injected via JS -->
                </div>
            </section>
        </div>

        <!-- 4. EXTRA SPENDING -->
        <section class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden mt-6">
            <div class="bg-red-50 p-3 border-b border-red-100 flex justify-between items-center">
                <h2 class="font-bold text-red-800 text-sm"><i class="fas fa-exclamation-circle mr-2"></i> Unbudgeted Spending</h2>
                <span class="text-red-600 font-bold" id="total-extra-display">$0.00</span>
            </div>
            <div class="p-4">
                <div class="flex flex-col sm:flex-row gap-2 mb-4">
                    <input type="date" id="exp-date" class="border p-2 rounded w-full sm:w-auto text-sm" />
                    <input type="text" id="exp-desc" placeholder="Details (e.g. Car Repair)" class="border p-2 rounded w-full text-sm" />
                    <input type="number" id="exp-amount" placeholder="Cost" class="border p-2 rounded w-full sm:w-32 text-sm" />
                    <button onclick="addExtraExpense()" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 font-medium text-sm shadow-sm">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
                <div id="expense-list" class="space-y-2 text-sm"></div>
            </div>
        </section>

        <!-- 5. RECURRING BILLS -->
        <section class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden mt-6">
            <div class="bg-yellow-50 p-3 border-b border-yellow-100 flex justify-between items-center">
                <h2 class="font-bold text-yellow-800 text-sm"><i class="fas fa-sync-alt mr-2"></i> Recurring Bills</h2>
                <button onclick="addRecurringBill()" class="bg-yellow-600 text-white px-3 py-1 rounded hover:bg-yellow-700 text-xs shadow-sm">
                    <i class="fas fa-plus"></i> Add Bill
                </button>
            </div>
            <div class="p-4">
                <div id="recurring-bills-list" class="space-y-2 text-sm"></div>
            </div>
        </section>

        <!-- 6. SAVINGS ACCOUNT -->
        <section class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden mt-6">
            <div class="bg-green-50 p-3 border-b border-green-100 flex justify-between items-center">
                <h2 class="font-bold text-green-800 text-sm"><i class="fas fa-piggy-bank mr-2"></i> Savings Account</h2>
            </div>
            <div class="p-4 flex items-center gap-3">
                <input type="number" id="savings-amount" placeholder="Enter Savings Amount" class="border p-2 rounded w-full max-w-xs" step="0.01" />
                <button onclick="saveSavings()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 font-medium text-sm shadow-sm">
                    Save
                </button>
            </div>
            <div class="p-4 pt-2 text-green-700 font-semibold" id="savings-display">$0.00</div>
        </section>

    </main>

    <!-- DASHBOARD -->
    <div class="fixed bottom-0 left-0 right-0 bg-white border-t-2 border-slate-200 shadow-[0_-5px_10px_rgba(0,0,0,0.1)] z-40 p-4 pb-8">
        <div class="max-w-4xl mx-auto">
            <div class="flex justify-between items-end mb-2">
                <h3 class="text-slate-500 font-bold text-xs uppercase tracking-widest">End of Month Reality</h3>
                <span class="text-xs text-gray-400">Total Income - Actual Spending</span>
            </div>
            
            <div class="grid grid-cols-3 gap-2 text-center">
                <div class="bg-slate-50 rounded p-2 border border-slate-200">
                    <div class="text-[10px] text-slate-500 uppercase font-semibold">Income</div>
                    <div class="font-bold text-blue-600 text-sm" id="dash-income">$0</div>
                </div>
                <div class="bg-slate-50 rounded p-2 border border-slate-200">
                    <div class="text-[10px] text-slate-500 uppercase font-semibold">Actual Out</div>
                    <div class="font-bold text-slate-700 text-sm" id="dash-out">$0</div>
                    <div class="text-[10px] text-gray-400" id="dash-proj-diff">Proj: $0</div>
                </div>
                <div class="bg-slate-50 rounded p-2 border-2 shadow-inner" id="dash-savings-box">
                    <div class="text-[10px] text-slate-500 uppercase font-semibold">Remaining</div>
                    <div class="font-extrabold text-lg" id="dash-savings">$0</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DATA ---
        
        // Static Wife Bills (Control Data)
        const wifeItems = [
            // 1st
            { id: 'w1c1', name: 'Spending Cash', amount: 200.00, section: 'wife1-body' },
            { id: 'w1c2', name: 'Shugosha (Wks 1-2)', amount: 200.00, section: 'wife1-body' },
            { id: 'w1b1', name: 'Susie Car', amount: 500.00, section: 'wife1-body' },
            { id: 'w1b2', name: 'USAA', amount: 371.00, section: 'wife1-body' },
            { id: 'w1b3', name: 'Toyota', amount: 250.00, section: 'wife1-body' },
            { id: 'w1b4', name: 'Storage Unit', amount: 200.00, section: 'wife1-body' },
            { id: 'w1b5', name: 'Home Depot', amount: 103.00, section: 'wife1-body' },
            { id: 'w1b6', name: 'New York Life', amount: 55.00, section: 'wife1-body' },
            { id: 'w1b7', name: 'Ed Financial', amount: 52.96, section: 'wife1-body' },
            // 15th
            { id: 'w2c1', name: 'Spending Cash', amount: 200.00, section: 'wife2-body' },
            { id: 'w2c2', name: 'Shugosha (Wks 3-4)', amount: 200.00, section: 'wife2-body' },
            { id: 'w2b1', name: 'AT&T', amount: 400.00, section: 'wife2-body' },
            { id: 'w2b2', name: 'AC Unit', amount: 380.00, section: 'wife2-body' },
            { id: 'w2b3', name: 'Costco', amount: 250.00, section: 'wife2-body' },
            { id: 'w2b4', name: 'Aidvantage', amount: 170.00, section: 'wife2-body' },
            { id: 'w2b5', name: 'Old Truck', amount: 150.00, section: 'wife2-body' },
            { id: 'w2b6', name: 'Penn Mutual', amount: 30.00, section: 'wife2-body' },
            { id: 'w2b7', name: 'Planet Fitness', amount: 30.00, section: 'wife2-body' },
            { id: 'w2b8', name: 'Cap One', amount: 28.00, section: 'wife2-body' },
            { id: 'w2b9', name: 'YouTube', amount: 25.00, section: 'wife2-body' },
            { id: 'w2b10', name: 'Audible', amount: 15.00, section: 'wife2-body' },
            { id: 'w2b11', name: 'Me Undies', amount: 15.00, section: 'wife2-body' },
            { id: 'w2b12', name: 'Apple', amount: 4.00, section: 'wife2-body' },
        ];

        // --- STATE MANAGEMENT ---
        let state = {
            checkedStatic: {}, // id: boolean
            actualAmounts: {}, // id: number (If different from projected)
            incomeLog: [],     // {id, date, desc, amount}
            expenseLog: [],    // {id, date, desc, amount}
            husbandCycles: [], // {id, date, groceriesChecked, gasChecked, groceryActual, gasActual}
            recurringBills: [], // {id, name, amount}
            savingsAmount: 0,
            editingId: null    // Current ID being edited
        };

        function init() {
            document.getElementById('inc-date').valueAsDate = new Date();
            document.getElementById('exp-date').valueAsDate = new Date();
            loadState();
            renderAll();
            renderRecurringBills();
            renderSavings();
        }

        function loadState() {
  database.ref('familyBudgetState').once('value').then(snapshot => {
    if (snapshot.exists()) {
      state = snapshot.val();
      // Ensure arrays exist:
      if (!state.recurringBills) state.recurringBills = [];
      if (state.savingsAmount === undefined) state.savingsAmount = 0;
      state.editingId = null;
    } else {
      // No data in DB, add defaults
      state.incomeLog.push({id: 1, date: new Date().toISOString().split('T')[0], desc: "Wife Check 1 (Est)", amount: 2200});
      state.incomeLog.push({id: 2, date: new Date().toISOString().split('T')[0], desc: "Wife Check 2 (Est)", amount: 2200});
    }
    renderAll();
  }).catch(error => {
    console.error('Firebase load error:', error);
    // Fallback to localStorage if you want:
    const saved = localStorage.getItem('budgetFinalState');
    if (saved) {
      state = JSON.parse(saved);
      renderAll();
    }
  });
}


        function saveState() {
            localStorage.setItem('budgetFinalState', JSON.stringify(state));
            calculateSummary();
        }

        function renderAll() {
            renderStaticBills();
            renderHusbandCycles();
            renderIncomeLog();
            renderExpenseLog();
            calculateSummary();
            renderRecurringBills();
            renderSavings();
        }

        // --- RENDERERS ---

        function renderStaticBills() {
            document.getElementById('wife1-body').innerHTML = '';
            document.getElementById('wife2-body').innerHTML = '';

            wifeItems.forEach(item => {
                const isChecked = state.checkedStatic[item.id] || false;
                const actual = state.actualAmounts[item.id] !== undefined ? state.actualAmounts[item.id] : item.amount;
                const isEditing = state.editingId === item.id;
                const diff = item.amount - actual;

                let rightSide = '';

                if (isEditing) {
                    rightSide = `
                        <div class="flex items-center gap-1">
                            <input type="number" id="edit-${item.id}" value="${actual}" class="border border-blue-400 rounded w-20 px-1 py-1 text-sm text-right" step="0.01">
                            <button onclick="saveEdit('${item.id}')" class="bg-blue-600 text-white p-1 rounded hover:bg-blue-700 w-8 h-8 flex justify-center items-center"><i class="fas fa-save"></i></button>
                        </div>
                    `;
                } else {
                    // Difference Indicator
                    let diffBadge = '';
                    if (diff > 0.01) diffBadge = `<span class="text-[10px] text-emerald-600 font-bold ml-1">(-$${diff.toFixed(0)})</span>`;
                    if (diff < -0.01) diffBadge = `<span class="text-[10px] text-red-500 font-bold ml-1">(+$${Math.abs(diff).toFixed(0)})</span>`;
                    
                    // If actual differs from projected, show visual cue
                    const amountClass = (Math.abs(diff) > 0.01) ? "font-bold text-indigo-700" : "font-bold text-gray-600";
                    const projLabel = (Math.abs(diff) > 0.01) ? `<div class="text-[9px] text-gray-400 text-right">Proj: $${item.amount.toFixed(0)}</div>` : '';

                    rightSide = `
                        <div class="text-right">
                            <div class="flex items-center justify-end gap-2">
                                <span class="text-sm ${amountClass}">$${actual.toFixed(2)}</span>
                                <button onclick="startEdit('${item.id}')" class="text-gray-300 hover:text-blue-500"><i class="fas fa-pen text-xs"></i></button>
                            </div>
                            ${projLabel}
                            ${diffBadge}
                        </div>
                    `;
                }

                const html = `
                    <div class="flex items-center justify-between p-2 rounded border border-b ${isChecked ? 'bg-emerald-50 border-emerald-100' : 'bg-white border-gray-100'}">
                        <div class="flex items-center gap-3">
                            <input type="checkbox" onchange="toggleStatic('${item.id}')" ${isChecked ? 'checked' : ''}>
                            <span class="${isChecked ? 'strikethrough text-gray-400' : 'text-gray-700'} text-sm font-medium">${item.name}</span>
                        </div>
                        ${rightSide}
                    </div>
                `;
                document.getElementById(item.section).innerHTML += html;
            });
        }

        function renderHusbandCycles() {
            const container = document.getElementById('husband-cycles-container');
            const emptyMsg = document.getElementById('husband-empty-msg');
            
            // Clear current list
            Array.from(container.children).forEach(child => {
                if (child.id !== 'husband-empty-msg') container.removeChild(child);
            });

            if (state.husbandCycles.length === 0) {
                emptyMsg.style.display = 'block';
            } else {
                emptyMsg.style.display = 'none';
                state.husbandCycles.forEach(cycle => {
                    const cycleTotal = cycle.groceryActual + cycle.gasActual;
                    
                    // Helper to render a row within the card
                    const renderRow = (label, keyChecked, keyActual, defaultAmt, keyIdBase) => {
                        const isEditing = state.editingId === `${cycle.id}-${keyIdBase}`;
                        const diff = defaultAmt - cycle[keyActual];
                        
                        if (isEditing) {
                            return `
                                <div class="flex justify-between items-center py-1">
                                    <span class="text-sm text-gray-700">${label}</span>
                                    <div class="flex items-center gap-1">
                                        <input type="number" id="edit-${cycle.id}-${keyIdBase}" value="${cycle[keyActual]}" class="border border-blue-400 rounded w-20 px-1 py-1 text-sm text-right">
                                        <button onclick="saveHusbandEdit(${cycle.id}, '${keyActual}', '${keyIdBase}')" class="bg-blue-600 text-white p-1 rounded w-8 h-8"><i class="fas fa-save"></i></button>
                                    </div>
                                </div>`;
                        } else {
                            let diffBadge = '';
                            if (diff > 0) diffBadge = `<span class="text-[9px] text-emerald-600 font-bold ml-1">(-$${diff})</span>`;
                            if (diff < 0) diffBadge = `<span class="text-[9px] text-red-500 font-bold ml-1">(+$${Math.abs(diff)})</span>`;

                            return `
                                <div class="flex justify-between items-center py-1">
                                    <label class="flex items-center gap-2 text-sm text-gray-700">
                                        <input type="checkbox" onchange="toggleHusbandItem(${cycle.id}, '${keyChecked}')" ${cycle[keyChecked] ? 'checked' : ''}>
                                        <span class="${cycle[keyChecked] ? 'strikethrough text-gray-400' : ''}">${label}</span>
                                    </label>
                                    <div class="flex items-center gap-2">
                                        <span class="font-bold text-gray-600 text-sm">$${cycle[keyActual]}</span>
                                        ${diffBadge}
                                        <button onclick="startEdit('${cycle.id}-${keyIdBase}')" class="text-gray-300 hover:text-blue-500 text-xs"><i class="fas fa-pen"></i></button>
                                    </div>
                                </div>`;
                        }
                    };

                    const card = document.createElement('div');
                    card.className = "bg-white border border-indigo-200 rounded-lg p-3 shadow-sm relative";
                    card.innerHTML = `
                        <div class="flex justify-between items-center mb-2 border-b border-indigo-50 pb-2">
                            <span class="font-bold text-indigo-800 text-sm">Pay Cycle (${cycle.date})</span>
                            <button onclick="deleteHusbandCycle(${cycle.id})" class="text-gray-300 hover:text-red-500 text-xs"><i class="fas fa-trash"></i></button>
                        </div>
                        <div class="space-y-1">
                            ${renderRow('Groceries', 'groceriesChecked', 'groceryActual', 300, 'groc')}
                            ${renderRow('Gas', 'gasChecked', 'gasActual', 120, 'gas')}
                        </div>
                        <div class="mt-2 pt-2 border-t border-indigo-50 flex justify-between items-center">
                            <span class="text-xs text-indigo-300">Default: $420</span>
                            <span class="text-xs text-indigo-600 font-bold">Actual Total: $${cycleTotal.toFixed(2)}</span>
                        </div>
                    `;
                    container.appendChild(card);
                });
            }
        }

        function renderIncomeLog() {
            const list = document.getElementById('income-list');
            list.innerHTML = '';
            let total = 0;
            state.incomeLog.forEach(item => {
                total += parseFloat(item.amount);
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center bg-blue-50 p-2 rounded border border-blue-100';
                div.innerHTML = `
                    <div><span class="font-bold text-blue-900">${item.desc}</span> <span class="text-xs text-blue-400 ml-2">${item.date}</span></div>
                    <div class="flex items-center gap-3">
                        <span class="font-bold text-blue-700">+$${parseFloat(item.amount).toFixed(2)}</span>
                        <button onclick="removeIncome(${item.id})" class="text-gray-400 hover:text-red-500"><i class="fas fa-times"></i></button>
                    </div>
                `;
                list.appendChild(div);
            });
            document.getElementById('total-income-display').innerText = `$${total.toFixed(2)}`;
        }

        function renderExpenseLog() {
            const list = document.getElementById('expense-list');
            list.innerHTML = '';
            let total = 0;
            state.expenseLog.forEach(item => {
                total += parseFloat(item.amount);
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center bg-red-50 p-2 rounded border border-red-100';
                div.innerHTML = `
                    <div><span class="font-bold text-red-900">${item.desc}</span> <span class="text-xs text-red-400 ml-2">${item.date}</span></div>
                    <div class="flex items-center gap-3">
                        <span class="font-bold text-red-700">-$${parseFloat(item.amount).toFixed(2)}</span>
                        <button onclick="removeExpense(${item.id})" class="text-gray-400 hover:text-red-500"><i class="fas fa-times"></i></button>
                    </div>
                `;
                list.appendChild(div);
            });
            document.getElementById('total-extra-display').innerText = `$${total.toFixed(2)}`;
        }

        // --- Recurring Bills and Savings ---

        function renderRecurringBills() {
            const container = document.getElementById('recurring-bills-list');
            container.innerHTML = '';
            if (state.recurringBills.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-xs italic">Add recurring bills here.</p>';
                return;
            }
            state.recurringBills.forEach(bill => {
                const html = `
                    <div class="flex justify-between items-center p-2 rounded border border-yellow-200 bg-yellow-50">
                        <span class="font-medium text-yellow-800">${bill.name}:</span>
                        <div class="flex items-center gap-3">
                            <span class="font-bold text-yellow-700">$${parseFloat(bill.amount).toFixed(2)}</span>
                            <button onclick="editRecurringBill(${bill.id})" class="text-yellow-500 hover:text-yellow-700 text-xs"><i class="fas fa-pen"></i></button>
                            <button onclick="removeRecurringBill(${bill.id})" class="text-red-400 hover:text-red-600 text-xs"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });
        }

        function addRecurringBill() {
            const name = prompt("Enter bill name:");
            if (!name) return;
            const amountStr = prompt("Enter monthly amount:");
            if (!amountStr) return;
            const amount = parseFloat(amountStr);
            if (isNaN(amount) || amount < 0) return alert("Invalid amount.");
            const id = Date.now();
            state.recurringBills.push({id, name, amount});
            saveState();
            renderRecurringBills();
        }

        function editRecurringBill(id) {
            const bill = state.recurringBills.find(b => b.id === id);
            if (!bill) return;
            const newName = prompt("Edit bill name:", bill.name);
            if (!newName) return;
            const newAmountStr = prompt("Edit monthly amount:", bill.amount);
            if (!newAmountStr) return;
            const newAmount = parseFloat(newAmountStr);
            if (isNaN(newAmount) || newAmount < 0) return alert("Invalid amount.");
            bill.name = newName;
            bill.amount = newAmount;
            saveState();
            renderRecurringBills();
        }

        function removeRecurringBill(id) {
            if (confirm("Remove this recurring bill?")) {
                state.recurringBills = state.recurringBills.filter(b => b.id !== id);
                saveState();
                renderRecurringBills();
            }
        }

        function saveSavings() {
            const input = document.getElementById('savings-amount');
            const val = parseFloat(input.value);
            if (isNaN(val) || val < 0) return alert("Enter a valid savings amount.");
            state.savingsAmount = val;
            saveState();
            renderSavings();
            input.value = '';
        }

        function renderSavings() {
            document.getElementById('savings-display').innerText = `$${state.savingsAmount.toFixed(2)}`;
        }

        // --- EDITING ACTIONS ---

        function startEdit(id) {
            state.editingId = id;
            renderAll();
        }

        function saveEdit(id) {
            const input = document.getElementById(`edit-${id}`);
            const val = parseFloat(input.value);
            if (!isNaN(val)) {
                state.actualAmounts[id] = val;
            }
            state.editingId = null;
            renderAll();
            saveState();
        }

        function saveHusbandEdit(cycleId, keyActual, keyIdBase) {
            const input = document.getElementById(`edit-${cycleId}-${keyIdBase}`);
            const val = parseFloat(input.value);
            
            const cycle = state.husbandCycles.find(c => c.id === cycleId);
            if (cycle && !isNaN(val)) {
                cycle[keyActual] = val;
            }
            state.editingId = null;
            renderAll();
            saveState();
        }

        // --- NORMAL ACTIONS ---

        function toggleStatic(id) {
            state.checkedStatic[id] = !state.checkedStatic[id];
            renderStaticBills();
            saveState();
        }

        function addHusbandCycle() {
            const today = new Date().toISOString().split('T')[0];
            state.husbandCycles.push({
                id: Date.now(),
                date: today,
                groceriesChecked: false,
                gasChecked: false,
                groceryActual: 300,
                gasActual: 120
            });
            renderHusbandCycles();
            saveState();
        }

        function deleteHusbandCycle(id) {
            if(confirm("Remove this pay cycle?")) {
                state.husbandCycles = state.husbandCycles.filter(c => c.id !== id);
                renderHusbandCycles();
                saveState();
            }
        }

        function toggleHusbandItem(cycleId, field) {
            const cycle = state.husbandCycles.find(c => c.id === cycleId);
            if(cycle) {
                cycle[field] = !cycle[field];
                renderHusbandCycles();
                saveState();
            }
        }

        function addIncome() {
            const d = document.getElementById('inc-date').value;
            const desc = document.getElementById('inc-desc').value;
            const amt = document.getElementById('inc-amount').value;
            if(!desc || !amt) return;
            state.incomeLog.push({id: Date.now(), date: d, desc: desc, amount: parseFloat(amt)});
            document.getElementById('inc-desc').value = '';
            document.getElementById('inc-amount').value = '';
            renderIncomeLog();
            saveState();
        }

        function removeIncome(id) {
            state.incomeLog = state.incomeLog.filter(i => i.id !== id);
            renderIncomeLog();
            saveState();
        }

        function addExtraExpense() {
            const d = document.getElementById('exp-date').value;
            const desc = document.getElementById('exp-desc').value;
            const amt = document.getElementById('exp-amount').value;
            if(!desc || !amt) return;
            state.expenseLog.push({id: Date.now(), date: d, desc: desc, amount: parseFloat(amt)});
            document.getElementById('exp-desc').value = '';
            document.getElementById('exp-amount').value = '';
            renderExpenseLog();
            saveState();
        }

        function removeExpense(id) {
            state.expenseLog = state.expenseLog.filter(i => i.id !== id);
            renderExpenseLog();
            saveState();
        }

        function resetMonth() {
            if(confirm("Start a new month? This clears everything.")) {
                state = { checkedStatic: {}, actualAmounts: {}, incomeLog: [], expenseLog: [], husbandCycles: [], recurringBills: [], savingsAmount: 0, editingId: null };
                // Add default wife income back
                state.incomeLog.push({id: 1, date: new Date().toISOString().split('T')[0], desc: "Wife Check 1 (Est)", amount: 2200});
                state.incomeLog.push({id: 2, date: new Date().toISOString().split('T')[0], desc: "Wife Check 2 (Est)", amount: 2200});
                saveState();
                location.reload();
            }
        }

        function toggleSection(id) {
            document.getElementById(id).classList.toggle('hidden');
        }

        // --- MATH ---

        // Keep original calculateSummary functionality but include recurring bills and savings in calculations

        function calculateSummary() {
            const totalIncome = state.incomeLog.reduce((s, i) => s + i.amount, 0);
            
            // 1. Calculate Actuals for Fixed Bills
            let fixedActualTotal = 0;
            let fixedProjTotal = 0;
            wifeItems.forEach(item => {
                fixedProjTotal += item.amount;
                // Use Actual if exists, else projected
                const act = state.actualAmounts[item.id] !== undefined ? state.actualAmounts[item.id] : item.amount;
                fixedActualTotal += act;
            });
            
            // 2. Calculate Actuals for Husband Cycles
            let husbActualTotal = 0;
            let husbProjTotal = 0;
            state.husbandCycles.forEach(cycle => {
                husbProjTotal += 420; // 300+120
                husbActualTotal += (cycle.groceryActual + cycle.gasActual);
            });

            // 3. Calculate Recurring Bills total (use projected amounts)
            let recurringTotal = 0;
            state.recurringBills.forEach(bill => {
                recurringTotal += bill.amount;
            });

            // 4. Extra Spending
            const extraTotal = state.expenseLog.reduce((s, i) => s + i.amount, 0);

            // Total Out Actual includes fixed, husband actuals, extra spending and recurring bills
            const totalOutActual = fixedActualTotal + husbActualTotal + extraTotal + recurringTotal;

            // Remaining is total income - total out actual - savings amount
            const remaining = totalIncome - totalOutActual - (state.savingsAmount || 0);

            const savEl = document.getElementById('dash-savings');
            const savBox = document.getElementById('dash-savings-box');

            document.getElementById('dash-income').innerText = `$${totalIncome.toFixed(0)}`;
            document.getElementById('dash-out').innerText = `$${totalOutActual.toFixed(0)}`;
            document.getElementById('dash-proj-diff').innerText = `Baseline + Recurring: $${(fixedProjTotal + husbProjTotal + recurringTotal + extraTotal).toFixed(0)}`;

            savEl.innerText = `$${remaining.toFixed(2)}`;
            if (remaining >= 0) {
                savEl.className = "font-extrabold text-lg text-emerald-600";
                savBox.className = "bg-emerald-50 rounded p-2 border-2 border-emerald-300 shadow-inner";
            } else {
                savEl.className = "font-extrabold text-lg text-red-600";
                savBox.className = "bg-red-50 rounded p-2 border-2 border-red-300 shadow-inner";
            }
        }

        window.onload = init;
    </script>
</body>
</html>
